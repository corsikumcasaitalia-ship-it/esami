<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Esame Livello IV - 2025/2026</title>
    <script src="studenti.js"></script>
    
    <style>
        /* GENEL AYARLAR */
        body { font-family: 'Segoe UI', Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        
        .container { 
            max-width: 800px; 
            margin: 10px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            padding-bottom: 100px; 
            display: none; 
        }

        #loginScreen { max-width: 90%; margin: 20px auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .honor-code { background: #fff3cd; padding: 15px; border: 1px solid #ffeeba; border-radius: 5px; margin: 20px 0; font-size: 0.85em; text-align: left; line-height: 1.4; }
        
        .password-box {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
        }

        .tech-warning {
            background-color: #e8f4f8;
            color: #0c5460;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.85em;
            text-align: left;
            margin-bottom: 20px;
        }
        .tech-warning ul { margin: 5px 0 0 20px; padding: 0; }
        .tech-warning li { margin-bottom: 5px; }

        .sticky-header { 
            position: sticky; top: 0; background: #2c3e50; color: white; padding: 10px 15px; z-index: 1000; 
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        .timer { font-size: 1.3em; font-weight: bold; color: #ffeb3b; font-family: monospace; }
        .save-status { font-size: 0.7em; color: #aaa; margin-left: 10px; }

        h1 { font-size: 1.5em; color: #333; margin-bottom: 10px; }
        h2 { font-size: 1.2em; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 25px; }
        
        .question { margin-bottom: 15px; padding: 12px; border-radius: 6px; border: 1px solid #eee; background: #fff; }
        .question label { display: block; padding: 8px 0; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .question input[type="radio"] { transform: scale(1.2); margin-right: 8px; }

        .reading-text { background: #e3f2fd; padding: 15px; border-left: 4px solid #2196f3; font-size: 1.0em; line-height: 1.8; margin-bottom: 10px; border-radius: 4px; }
        
        .vocab { color: #d63384; font-weight: bold; text-decoration: underline dotted; cursor: pointer; position: relative; }
        .vocab:hover { background-color: #fce4ec; }

        #vocab-toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #vocab-toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        details.helper-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin-bottom: 15px; font-size: 0.9em; }
        details.helper-box summary { font-weight: bold; color: #007bff; cursor: pointer; outline: none; margin-bottom: 5px; }
        .phrase-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { background: #e9ecef; border: 1px solid #ced4da; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; cursor: pointer; transition: 0.2s; color: #495057; }
        .chip:hover { background: #007bff; color: white; border-color: #007bff; }
        .chip:active { transform: scale(0.95); }

        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; font-family: inherit; }
        
        .inline-input {
            width: 130px !important; display: inline-block !important; margin: 0 5px; padding: 5px !important; height: 30px;
            border-bottom: 2px solid #007bff !important; border-top: none !important; border-left: none !important; border-right: none !important;
            border-radius: 0 !important; background: #f8f9fa; text-align: center; color: #333; font-weight: bold;
        }

        textarea { resize: vertical; min-height: 150px; line-height: 1.5; }

        .btn { display: block; width: 100%; padding: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 25px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-start { background: #28a745; color: white; opacity: 0.5; }
        .btn-submit { background: #007bff; color: white; margin-bottom: 30px; }
        .btn:disabled { background: #bdc3c7; opacity: 0.5; cursor: not-allowed; }
        .btn-restore { background: #ffc107; color: #333; display: none; margin-bottom: 10px; }
        .copy-btn { background: #6f42c1; color: white; margin-top: 10px; }
        .reset-btn { background: #dc3545; color: white; margin-top: 20px; font-size: 14px; padding: 10px; }

        .cheat-alert { display: none; background: #e74c3c; color: white; text-align: center; padding: 12px; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; font-size: 0.9em; }

        audio { width: 100%; margin-top: 10px; height: 40px; }
        
        .result-box { width: 100%; height: 300px; font-family: monospace; font-size: 0.9em; background: #f8f9fa; border: 1px solid #ccc; }
        
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="vocab-toast">Anlamƒ± burada g√∂r√ºnecek</div>

<div id="cheatBanner" class="cheat-alert">
    ‚ö†Ô∏è UYARI: EKRANDAN AYRILDINIZ! <br>
    <span style="font-weight:normal; font-size:0.8em;">Bu durum kayƒ±t altƒ±na alƒ±ndƒ±.</span>
</div>

<div id="loginScreen">
    <h1>üáÆüáπ Esame Livello IV</h1>
    <p style="color:#666;">2025/2026 Online Sƒ±nav Giri≈üi</p>
    
    <div class="tech-warning">
        <strong>‚ö†Ô∏è √ñNEMLƒ∞ TEKNƒ∞K KURALLAR:</strong>
        <ul>
            <li>L√ºtfen <strong>"Gizli Sekme" (Incognito)</strong> kullanmayƒ±nƒ±z! (Sistem kayƒ±t yapamaz).</li>
            <li>Elektrik kesilirse veya sayfa kapanƒ±rsa panik yapmayƒ±n. Sƒ±nava <strong>AYNI Cƒ∞HAZ ve AYNI TARAYICI</strong> ile tekrar girerseniz, cevaplarƒ±nƒ±z ve s√ºreniz kaldƒ±ƒüƒ± yerden devam edecektir.</li>
        </ul>
    </div>

    <button id="restoreBtn" class="btn btn-restore" onclick="restoreSession()">
        üîÑ √ñnceki oturumunuz bulundu! <br><span style="font-size:0.8em">Kaldƒ±ƒüƒ±nƒ±z yerden devam etmek i√ßin tƒ±klayƒ±n.</span>
    </button>

    <div id="newSessionForm">
        
        <div class="password-box">
            <label style="color:#0d47a1; font-weight:bold;">üîí Sƒ±nav Giri≈ü Kodu:</label>
            <input type="password" id="examPassword" placeholder="√ñƒüretmeninizden aldƒ±ƒüƒ±nƒ±z ≈üifre..." oninput="checkStartButton()">
        </div>

        <div style="text-align: left; margin-top: 20px;">
            <label><strong>Adƒ±nƒ±z Soyadƒ±nƒ±z:</strong></label>
            <input type="text" id="studentName" list="studentListOptions" placeholder="Listeden se√ßin veya isminizi yazƒ±n..." oninput="checkStartButton()">
            <datalist id="studentListOptions"></datalist>
        </div>

        <div class="honor-code">
            <label style="display: flex; align-items: flex-start; gap: 10px;">
                <input type="checkbox" id="honorCheck" onchange="checkStartButton()">
                <span>
                    <strong>‚ö†Ô∏è SINAV UYARISI:</strong><br>
                    Bilgisayarda <strong>sekme deƒüi≈ütirmek</strong>; <br>
                    Telefon/Tablette ise <strong>bildirim veya arama gelmesi</strong> "Ekran ƒ∞hlali" sayƒ±lƒ±r.<br>
                    L√ºtfen cihazƒ±nƒ±zda gerekli √∂nlemleri alƒ±nƒ±z.<br>
                    Kopya √ßekmeyeceƒüimi taahh√ºt ediyorum.
                </span>
            </label>
        </div>

        <button id="startBtn" class="btn btn-start" onclick="attemptLogin()" disabled>Gƒ∞Rƒ∞≈û YAP VE BA≈ûLAT</button>
    </div>
</div>

<div id="examInterface">
    
    <div class="sticky-header">
        <div style="display:flex; flex-direction:column;">
            <div class="student-name-display" id="displayName">...</div>
            <div id="saveStatus" class="save-status">Kaydedildi</div>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
            <span>‚è±Ô∏è</span>
            <div id="timerDisplay" class="timer">50:00</div>
        </div>
    </div>

    <div class="container">
        
        <div class="section">
            <h2>üéß 1. ASCOLTO (10 Punti)</h2>
            <p>Ascolta il dialogo tra Enrico e Marina e completa le frasi.</p>
            <div style="background: #f1f3f5; padding: 15px; border-radius: 8px; text-align: center;">
                <p style="margin:0 0 5px 0; font-weight:bold;">Ses Dosyasƒ±:</p>
                <audio id="examAudio" controls controlsList="nodownload" onplay="checkAudioLimit()" onended="countAudioPlay()">
                    <source src="esame4.mp3" type="audio/mpeg">
                    Tarayƒ±cƒ±nƒ±z sesi desteklemiyor.
                </audio>
            </div>
            
            <div class="question">
                <p><strong>1. Nella foto in corridoio, Enrico:</strong></p>
                <label><input type="radio" name="q1" value="a" onchange="autoSave()"> a. aveva quindici anni</label>
                <label><input type="radio" name="q1" value="b" onchange="autoSave()"> b. era in Toscana</label>
                <label><input type="radio" name="q1" value="c" onchange="autoSave()"> c. era in Sardegna</label>
            </div>
            <div class="question">
                <p><strong>2. Di solito, Enrico e la sua famiglia:</strong></p>
                <label><input type="radio" name="q2" value="a" onchange="autoSave()"> a. andavano in vacanza in Sardegna</label>
                <label><input type="radio" name="q2" value="b" onchange="autoSave()"> b. andavano in Toscana</label>
                <label><input type="radio" name="q2" value="c" onchange="autoSave()"> c. andavano in aereo</label>
            </div>
            <div class="question">
                <p><strong>3. Da piccola Marina:</strong></p>
                <label><input type="radio" name="q3" value="a" onchange="autoSave()"> a. andava spesso al mare</label>
                <label><input type="radio" name="q3" value="b" onchange="autoSave()"> b. non √® mai andata al mare</label>
                <label><input type="radio" name="q3" value="c" onchange="autoSave()"> c. andava poco al mare</label>
            </div>
            <div class="question">
                <p><strong>4. Tutti i giorni, il padre di Marina:</strong></p>
                <label><input type="radio" name="q4" value="a" onchange="autoSave()"> a. era triste</label>
                <label><input type="radio" name="q4" value="b" onchange="autoSave()"> b. comprava il giornale</label>
                <label><input type="radio" name="q4" value="c" onchange="autoSave()"> c. leggeva i fumetti</label>
            </div>
            <div class="question">
                <p><strong>5. Marina:</strong></p>
                <label><input type="radio" name="q5" value="a" onchange="autoSave()"> a. amava fare lunghe passeggiate</label>
                <label><input type="radio" name="q5" value="b" onchange="autoSave()"> b. era antipatica</label>
                <label><input type="radio" name="q5" value="c" onchange="autoSave()"> c. ha conosciuto suo marito in vacanza</label>
            </div>
        </div>

        <div class="section">
            <h2>üìñ 2. LETTURA (10 Punti)</h2>
            <p style="font-size:0.8em; color:gray; text-align:center; margin-bottom:5px;">‚ÑπÔ∏è ƒ∞pucu: Kelimelere tƒ±klayarak anlamƒ±nƒ± g√∂rebilirsiniz.</p>
            
            <div class="reading-text">
                <strong>UNA DOLCE STORIA: COME √à NATO IL TIRAMIS√ô</strong><br><br>
                Il tiramis√π √® sicuramente il dolce italiano pi√π conosciuto al mondo. Eppure non tutti conoscono la sua storia e ci sono diverse teorie sulla sua origine.<br><br>
                Secondo la tradizione, il dolce √® nato a Treviso, una citt√† della regione Veneto. Alcuni storici dicono che gi√† nel 1800 molte mamme a Treviso preparavano regolarmente il tiramis√π per i loro bambini, anche se a quel tempo il dolce si chiamava <span class="vocab" onclick="showDef('Eski bir isim')">‚Äúsbatudin‚Äù</span> nel dialetto locale ed aveva una ricetta pi√π semplice: gli ingredienti erano solo zucchero e <span class="vocab" onclick="showDef('Tuorlo = Yumurta sarƒ±sƒ±')">tuorlo</span>.<br><br>
                Tuttavia, come ha scritto il gastronomo Giuseppe Maffioli nel suo libro <em>La Cucina trevigiana</em>, intorno al 1960 il pasticciere <span class="vocab" onclick="showDef('Tiramisunun yaratƒ±cƒ±sƒ±')">Aldo Campeol</span> ha creato la versione classica del tiramis√π come lo conosciamo oggi.<br><br>
                Altri autori per√≤ non credono a questa teoria: secondo loro, il tiramis√π √® nato in Toscana o a Torino.<br><br>
                In ogni caso, oggi tutti conoscono la ricetta classica del tiramis√π: mascarpone, uova, zucchero, <span class="vocab" onclick="showDef('Savoiardi = Kedi dili bisk√ºvi')">savoiardi</span>, caff√® e cacao in polvere.<br><br>
                Per creare questa ricetta, Campeol ha usato ingredienti che provengono da diverse regioni d‚ÄôItalia e non solo dal Veneto. Per esempio, il mascarpone √® un formaggio cremoso nato in Lombardia, mentre i biscotti savoiardi sono tipici del Piemonte.<br><br>
                Molti cuochi italiani aggiungono spesso anche un po‚Äô di Marsala, un vino <span class="vocab" onclick="showDef('Lik√∂rl√º ≈üarap')">liquoroso</span> tipico della Sicilia.<br><br>
                Il tiramis√π √® diventato cos√¨ famoso che nel 2017 √® stato creato un torneo per decidere chi √® il pasticcere pi√π bravo al mondo, la Tiramis√π World Cup.<br><br>
                Nel 2023, per la prima volta una persona non italiana ha vinto il torneo: la vincitrice √® stata infatti Patricia Guerra, una pasticcera brasiliana di San Paolo!
            </div>

            <div class="question">
                <p><strong>1. Il tiramis√π:</strong></p>
                <label><input type="radio" name="q6" value="a" onchange="autoSave()"> a. √® molto famoso all‚Äôestero</label>
                <label><input type="radio" name="q6" value="b" onchange="autoSave()"> b. non √® molto conosciuto</label>
                <label><input type="radio" name="q6" value="c" onchange="autoSave()"> c. non ha avuto origine in Italia</label>
            </div>
            <div class="question">
                <p><strong>2. In passato il tiramis√π:</strong></p>
                <label><input type="radio" name="q7" value="a" onchange="autoSave()"> a. si preparava con tanti ingredienti</label>
                <label><input type="radio" name="q7" value="b" onchange="autoSave()"> b. aveva un nome diverso</label>
                <label><input type="radio" name="q7" value="c" onchange="autoSave()"> c. era preparato dai bambini</label>
            </div>
            <div class="question">
                <p><strong>3. La persona che ha creato il tiramis√π moderno si chiamava:</strong></p>
                <label><input type="radio" name="q8" value="a" onchange="autoSave()"> a. Sbadutin</label>
                <label><input type="radio" name="q8" value="b" onchange="autoSave()"> b. Aldo Campeol</label>
                <label><input type="radio" name="q8" value="c" onchange="autoSave()"> c. Giuseppe Maffioli</label>
            </div>
            <div class="question">
                <p><strong>4. Nella ricetta classica del tiramis√π:</strong></p>
                <label><input type="radio" name="q9" value="a" onchange="autoSave()"> a. ci sono ingredienti tipici di tante regioni italiane</label>
                <label><input type="radio" name="q9" value="b" onchange="autoSave()"> b. ci sono solo ingredienti tipici del Veneto</label>
                <label><input type="radio" name="q9" value="c" onchange="autoSave()"> c. ci sono le fragole</label>
            </div>
            <div class="question">
                <p><strong>5. Nel 2023, per la prima volta:</strong></p>
                <label><input type="radio" name="q10" value="a" onchange="autoSave()"> a. La Tiramis√π World Cup √® stata in Brasile</label>
                <label><input type="radio" name="q10" value="b" onchange="autoSave()"> b. Una donna italiana ha vinto la Tiramis√π World Cup</label>
                <label><input type="radio" name="q10" value="c" onchange="autoSave()"> c. Una persona straniera ha vinto la Tiramis√π World Cup</label>
            </div>
        </div>

        <div class="section">
            <h2>‚úçÔ∏è 3. GRAMMATICA (5 Punti)</h2>
            <div style="background:#f1f3f5; padding:5px; margin:10px 0; border-radius:5px; text-align:center;">
                <span style="font-size:0.9em; color:#333; margin-right:10px;">√ñzel Karakter Ekle:</span>
                <button onmousedown="event.preventDefault(); typeChar('√†')" style="padding:5px 12px; font-size:1.1em; cursor:pointer;">√†</button>
                <button onmousedown="event.preventDefault(); typeChar('√®')" style="padding:5px 12px; font-size:1.1em; cursor:pointer;">√®</button>
            </div>
            
            <p style="font-size:0.9em; color:#666;">Completa le frasi con i verbi all'<strong>imperfetto</strong>:</p>
            
            <div class="question" style="line-height: 2.2; font-size: 1.1em;">
                (Essere) <input type="text" id="g1" placeholder="..." oninput="autoSave()" class="inline-input"> una domenica di Gennaio.<br>
                La moglie di Ferdinando (avere) <input type="text" id="g2" placeholder="..." oninput="autoSave()" class="inline-input"> bisogno di soldi per fare la spesa.<br>
                Lei √® andata a guardare nelle tasche dei pantaloni di suo maritozzo.<br>
                Mentre la moglie (scoprire) <input type="text" id="g3" placeholder="..." oninput="autoSave()" class="inline-input"> che le tasche dei pantaloni (essere) <input type="text" id="g4" placeholder="..." oninput="autoSave()" class="inline-input"> vuote, il marito (cercare) <input type="text" id="g5" placeholder="..." oninput="autoSave()" class="inline-input"> un po‚Äô di soldi dentro la borsetta della moglie.
            </div>
        </div>

        <div class="section">
            <h2>üìù 4. PRODUZIONE SCRITTA (5 Punti)</h2>
            <p><strong>Scegli una traccia (1, 2 o 3) e scrivi un tuo ricordo (40-60 parole):</strong></p>
            <ul style="font-size:0.9em; color:#555;">
                <li>1) L‚Äôultimo film/serie tv che hai visto</li>
                <li>2) L‚Äôultimo libro che hai letto</li>
                <li>3) L‚Äôultima vacanza che hai fatto</li>
            </ul>
            
            <div style="background:#eaf6ff; border:1px solid #b6e0fe; padding:10px; border-radius:8px; margin-bottom:10px;">
                <p style="margin:0 0 5px 0; font-weight:bold; font-size:0.9em; color:#0056b3;">üí° Yardƒ±mcƒ± Kalƒ±plar (Anƒ± Anlatma)</p>
                
                <details class="helper-box">
                    <summary>1. Giri≈ü (Zaman ve Yer)</summary>
                    <div class="phrase-chips">
                        <span class="chip" onclick="addPhrase('L\'estate scorsa sono andato/a a...')">L'estate scorsa sono andato/a a...</span>
                        <span class="chip" onclick="addPhrase('Il mese scorso ho letto un libro che si chiama...')">Il mese scorso ho letto un libro che si chiama...</span>
                        <span class="chip" onclick="addPhrase('Ieri ho guardato un film bellissimo...')">Ieri ho guardato un film bellissimo...</span>
                    </div>
                </details>

                <details class="helper-box">
                    <summary>2. Olay √ñrg√ºs√º (Ne oldu?)</summary>
                    <div class="phrase-chips">
                        <span class="chip" onclick="addPhrase('La storia parlava di...')">La storia parlava di...</span>
                        <span class="chip" onclick="addPhrase('C\'era un personaggio che...')">C'era un personaggio che...</span>
                        <span class="chip" onclick="addPhrase('Abbiamo visitato...')">Abbiamo visitato...</span>
                        <span class="chip" onclick="addPhrase('Faceva molto caldo/freddo...')">Faceva molto caldo/freddo...</span>
                    </div>
                </details>

                <details class="helper-box">
                    <summary>3. D√º≈ü√ºnceler (Beƒüendim √ß√ºnk√º...)</summary>
                    <div class="phrase-chips">
                        <span class="chip" onclick="addPhrase('Mi √® piaciuto molto perch√©...')">Mi √® piaciuto molto perch√©...</span>
                        <span class="chip" onclick="addPhrase('√à stato molto divertente/interessante.')">√à stato molto divertente/interessante.</span>
                        <span class="chip" onclick="addPhrase('Non mi √® piaciuto per niente.')">Non mi √® piaciuto per niente.</span>
                    </div>
                </details>
            </div>

            <div style="margin-bottom:8px; display:flex; gap:5px; flex-wrap:wrap; background:#f1f3f5; padding:8px; border-radius:5px;">
                <button onmousedown="event.preventDefault(); typeChar('√†')" style="padding:5px 12px;">√†</button>
                <button onmousedown="event.preventDefault(); typeChar('√®')" style="padding:5px 12px;">√®</button>
                <button onmousedown="event.preventDefault(); typeChar('√©')" style="padding:5px 12px;">√©</button>
                <button onmousedown="event.preventDefault(); typeChar('√¨')" style="padding:5px 12px;">√¨</button>
                <button onmousedown="event.preventDefault(); typeChar('√≤')" style="padding:5px 12px;">√≤</button>
                <button onmousedown="event.preventDefault(); typeChar('√π')" style="padding:5px 12px;">√π</button>
            </div>
            
            <textarea id="writingAnswer" rows="6" placeholder="Buraya yazƒ±n..." oninput="autoSave()"></textarea>
        </div>

        <button class="btn btn-submit" onclick="finishExam(false)">SINAVI Bƒ∞Tƒ∞R VE G√ñNDER</button>
    </div>
</div>

<div id="resultScreen" style="display:none; text-align:center;">
    <h2 id="resultTitle" style="color:#28a745;">‚úÖ Sƒ±nav Ba≈üarƒ±yla Tamamlandƒ±!</h2>
    <div id="successContent">
        <p>Sonu√ßlarƒ±nƒ±z √∂ƒüretmeninize ba≈üarƒ±yla iletildi.</p>
        <div style="font-size:3rem; margin:20px;">üéâ</div>
        <p>Bu pencereyi kapatabilirsiniz.</p>
    </div>
    <div id="backupArea" style="display:none; margin-top:30px; border-top:2px dashed #ccc; padding-top:20px;">
        <p style="color:#dc3545; font-weight:bold; font-size:1.2em;">‚ö†Ô∏è Otomatik g√∂nderim ba≈üarƒ±sƒ±z oldu.</p>
        <p>L√ºtfen a≈üaƒüƒ±daki raporu kopyalayƒ±p WhatsApp'tan √∂ƒüretmeninize g√∂nderin:</p>
        <textarea id="finalReport" class="result-box" readonly></textarea>
        <button class="btn copy-btn" onclick="copyResult()">üìã RAPORU KOPYALA</button>
    </div>
    <button class="btn reset-btn" onclick="hardReset()">‚ö†Ô∏è Sƒ∞STEMƒ∞ SIFIRLA VE √áIKI≈û YAP</button>
</div>

<script>
    // --- MAƒ∞L ADRESƒ∞ ---
    t TEACHER_EMAIL = "corsikumcasaitalia@gmail.com";
    
    // --- √ñƒûRETMEN AYARLARI ---
    t TEACHER_PASSWORD = "START";
    t EXAM_DURATION_MINUTES = 50; 
    t SAVE_KEY = "esame_livello4_2025_v1"; 
    
    // --- PUANLAMA AYARLARI ---
    t POINTS_TEST = 2;    
    t POINTS_GRAMMAR = 1; 

    // --- ≈ûƒ∞FRELƒ∞ Gƒ∞ZLƒ∞ ƒ∞Sƒ∞MLER ---
    t SECRET_HASHES = [
        "Um9tYV8xODYx",       
        "RGFudGVfMTI2NQ==",   
        "VmVyZGlfTmFidWNjbw==" 
    ];

    // --- CEVAP ANAHTARI (Dƒ∞KKAT: Dƒ∞NLEME METNƒ∞NE G√ñRE G√úNCELLENDƒ∞) ---
    t ANSWER_KEY = {
        // Ascolto (Dinleme):
        q1: "c", // Sardegna ("Ero in Sardegna")
        q2: "b", // Toscana ("andavamo... in Toscana")
        q3: "c", // andava poco al mare
        q4: "b", // comprava il giornale
        q5: "c", // ha conosciuto suo marito
        
        // Lettura (Okuma):
        q6: "a", // famoso all'estero
        q7: "b", // nome diverso (sbatudin)
        q8: "b", // Aldo Campeol
        q9: "a", // ingredienti di tante regioni
        q10: "c", // persona straniera (Brezilyalƒ±)

        // Grammatica (Imperfetto):
        g1: ["era"], 
        g2: ["aveva"], 
        g3: ["scopriva"], 
        g4: ["erano"], 
        g5: ["cercava"]
    };

    let timerInterval, violationCount = 0, examLogs = [], audioLimit = 2;

    window.onload = function() {
        populateStudentList();
        let savedData = {};
        try { savedData = JSON.parse(localStorage.getItem(SAVE_KEY)) || {}; } catch(e) { savedData = {}; }

        let isMaster = (savedData.name) ? SECRET_HASHES.includes(btoa(savedData.name)) : false;
        if (isMaster) {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('examInterface').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
            return;
        }

        if(localStorage.getItem(SAVE_KEY + "_status") === "completed") { 
            showResultScreen(true);
            return; 
        }

        if(localStorage.getItem(SAVE_KEY + "_startTime")) { 
            document.getElementById('restoreBtn').style.display = 'block'; 
            document.getElementById('newSessionForm').style.display = 'none'; 
        }
    }

    function populateStudentList() {
        t dataList = document.getElementById("studentListOptions");
        if (typeof OGRENCI_LISTESI !== 'undefined') {
            OGRENCI_LISTESI.forEach(name => {
                let opt = document.createElement("option");
                opt.value = name;
                dataList.appendChild(opt);
            });
        }
    }

    function attemptLogin() {
        t inputName = document.getElementById('studentName').value.trim();
        t inputPass = document.getElementById('examPassword').value.trim();
        let isMaster = false;
        try { isMaster = SECRET_HASHES.includes(btoa(inputName)); } catch(e){}

        if (isMaster) {
            localStorage.removeItem(SAVE_KEY + "_status");
            localStorage.removeItem(SAVE_KEY + "_startTime");
            localStorage.removeItem("LOCK_" + inputName);
            startExam(false);
            return;
        }

        if (inputPass !== TEACHER_PASSWORD) { alert("‚ùå HATALI SINAV ≈ûƒ∞FRESƒ∞!"); return; }
        if (localStorage.getItem("LOCK_" + inputName) === "completed") { alert("‚õî BU √ñƒûRENCƒ∞ SINAVI ZATEN TAMAMLADI!"); return; }

        if (typeof OGRENCI_LISTESI !== 'undefined' && OGRENCI_LISTESI.includes(inputName)) { startExam(false); } 
        else { alert("‚õî BU ƒ∞Sƒ∞MLE Gƒ∞Rƒ∞≈û YETKƒ∞Nƒ∞Z YOK!"); }
    }

    function checkStartButton() {
        t name = document.getElementById('studentName').value;
        t pass = document.getElementById('examPassword').value;
        t check = document.getElementById('honorCheck').checked;
        t startBtn = document.getElementById('startBtn');
        if (name.length > 0 && pass.length > 0 && check) {
            startBtn.disabled = false; startBtn.style.opacity = "1"; startBtn.style.backgroundColor = "#28a745";
        } else {
            startBtn.disabled = true; startBtn.style.opacity = "0.5";
        }
    }

    function startExam(isRestored = false) {
        if(!isRestored) examLogs.push("[" + new Date().toLocaleTimeString() + "] Sƒ±nav Ba≈üladƒ±.");
        let sName = document.getElementById('studentName').value;
        if(isRestored) { let d = JSON.parse(localStorage.getItem(SAVE_KEY)); if(d) sName = d.name; }
        if (!localStorage.getItem(SAVE_KEY + "_startTime")) localStorage.setItem(SAVE_KEY + "_startTime", new Date().getTime());

        document.getElementById('displayName').innerText = sName;
        document.getElementById('loginScreen').style.display = 'none';
        document.querySelector('.container').style.display = 'block';
        document.getElementById('examInterface').style.display = 'block'; 
        
        if(isRestored) restoreInputs(); 
        timerInterval = setInterval(updateAbsoluteTimer, 1000);
        updateAbsoluteTimer();
        window.scrollTo(0,0);
        checkAudioLimit();
    }

    function updateAbsoluteTimer() {
        let st = parseInt(localStorage.getItem(SAVE_KEY + "_startTime"));
        if(!st) return;
        let elapsed = Math.floor((new Date().getTime() - st) / 1000);
        let remain = (EXAM_DURATION_MINUTES * 60) - elapsed;
        
        if (remain <= 0) { clearInterval(timerInterval); document.getElementById('timerDisplay').innerText = "00:00"; finishExam(true); return; }
        let m = Math.floor(remain / 60), s = remain % 60;
        document.getElementById('timerDisplay').innerText = (m<10?'0':'')+m + ":" + (s<10?'0':'')+s;
        if (remain <= 300) document.getElementById('timerDisplay').style.color = "red";
        if(remain % 10 === 0) autoSave();
    }

    function autoSave() {
        let answers = {}, grammar = {};
        for(let i=1; i<=10; i++) { let r = document.querySelector(`input[name="q${i}"]:checked`); if(r) answers["q"+i] = r.value; }
        for(let i=1; i<=5; i++) { grammar["g"+i] = document.getElementById('g'+i).value; }
        let data = { name: document.getElementById('displayName').innerText, writing: document.getElementById('writingAnswer').value, answers: answers, grammar: grammar, logs: examLogs, violations: violationCount };
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        let st = document.getElementById('saveStatus'); if(st) { st.innerText = "Kaydedildi"; setTimeout(() => { st.innerText = ""; }, 1000); }
    }

    function restoreInputs() {
        let data = JSON.parse(localStorage.getItem(SAVE_KEY));
        if(!data) return;
        violationCount = data.violations || 0; examLogs = data.logs || [];
        if(data.answers) for(let i=1; i<=10; i++) { if(data.answers["q"+i]) { let el = document.querySelector(`input[name="q${i}"][value="${data.answers["q"+i]}"]`); if(el) el.checked = true; } }
        if(data.grammar) for(let i=1; i<=5; i++) { if(data.grammar["g"+i]) document.getElementById('g'+i).value = data.grammar["g"+i]; }
        if(data.writing) document.getElementById('writingAnswer').value = data.writing;
    }

    function checkAudioLimit() {
        let played = parseInt(localStorage.getItem(SAVE_KEY + "_audioPlay")) || 0;
        let p = document.getElementById("examAudio");
        if (played >= audioLimit) { if(!p.paused) { p.pause(); p.currentTime = 0; alert("‚ö†Ô∏è Dinleme hakkƒ± doldu!"); } p.style.opacity = "0.5"; p.style.pointerEvents = "none"; }
    }
    function countAudioPlay() {
        let played = parseInt(localStorage.getItem(SAVE_KEY + "_audioPlay")) || 0;
        played++; localStorage.setItem(SAVE_KEY + "_audioPlay", played);
        if(played >= audioLimit) { alert("Dinleme hakkƒ± bitti."); document.getElementById("examAudio").style.opacity = "0.5"; document.getElementById("examAudio").style.pointerEvents = "none"; }
    }

    let ayrilmaZamani;
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) { ayrilmaZamani = new Date().getTime(); } else {
            if (ayrilmaZamani && document.getElementById('examInterface').style.display !== 'none') {
                let farkSaniye = Math.floor((new Date().getTime() - ayrilmaZamani) / 1000);
                violationCount++;
                examLogs.push("[" + new Date().toLocaleTimeString() + "] ‚ö†Ô∏è ƒ∞HLAL: Ekran Terk Edildi. " + farkSaniye + "sn.");
                document.getElementById('cheatBanner').style.display = 'block';
                setTimeout(() => { document.getElementById('cheatBanner').style.display = 'none'; }, 4000);
                ayrilmaZamani = null;
            }
        }
    });

    function generateReport() {
        let data = JSON.parse(localStorage.getItem(SAVE_KEY)) || {};
        let totalScore = 0;
        
        let report = "--- ƒ∞TALYANCA SINAV SONUCU (LEVEL 4) ---\n";
        report += "√ñƒürenci: " + (data.name || "-") + "\n";
        report += "Tarih: " + new Date().toLocaleString() + "\n";
        
        let details = "\n[TEST B√ñL√úM√ú (20 Puan)]\n";
        if(data.answers) {
            for(let i=1; i<=10; i++) {
                let ans = data.answers["q"+i];
                let correct = ANSWER_KEY["q"+i];
                let isCorrect = (ans === correct);
                if(isCorrect) totalScore += POINTS_TEST;
                details += i + ". " + (ans ? ans.toUpperCase() : "-") + " " + (isCorrect ? "‚úÖ" : "‚ùå") + "\n";
            }
        }

        details += "\n[GRAMER B√ñL√úM√ú (5 Puan)]\n";
        if(data.grammar) {
            for(let i=1; i<=5; i++) {
                let ans = (data.grammar["g"+i] || "").trim();
                let correctOptions = ANSWER_KEY["g"+i]; 
                let isCorrect = correctOptions.some(opt => opt.toLowerCase() === ans.toLowerCase());
                if(isCorrect) totalScore += POINTS_GRAMMAR;
                details += "G" + i + ": " + ans + " " + (isCorrect ? "‚úÖ" : "‚ùå") + "\n";
            }
        }

        report += "OTOMATƒ∞K PUAN: " + totalScore + " / 25\n";
        report += "ƒ∞HLAL SAYISI: " + (data.violations || 0) + "\n";
        report += "\n[DETAYLAR]\n" + details; 
        report += "\n[KOMPOZƒ∞SYON_4]\n" + (data.writing || "-") + "\n";
        
        report += "\n[LOGLAR]\n";
        if(data.logs) data.logs.forEach(log => { report += log + "\n"; });
        
        return report;
    }

    function finishExam(forced) {
        if(!forced && !confirm("Sƒ±navƒ± bitirmek ve hocaya g√∂ndermek istediƒüinize emin misiniz?")) return;
        
        clearInterval(timerInterval); 
        autoSave();
        
        const submitBtn = document.querySelector('.btn-submit');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner"></div> L√ºtfen Bekleyin...';

        let sName = document.getElementById('displayName').innerText;
        localStorage.setItem("LOCK_" + sName, "completed");
        localStorage.setItem(SAVE_KEY + "_status", "completed");
        
        let reportText = generateReport();
        document.getElementById('finalReport').value = reportText;
        
      // --- finishExam Fonksiyonunun ƒ∞√ßindeki formData Kƒ±smƒ± ---
        
        const formData = {
            // KONU BA≈ûLIƒûI: Robotun g√∂z√ºne sokuyoruz
            _subject: "üáÆüáπ Sƒ±nav: " + sName + " - [KOMPOZƒ∞SYON_4]",
            
            Ogrenci: sName,
            
            // ƒ∞√áERƒ∞K: Robotun okumasƒ± i√ßin temiz satƒ±r
            Sinav_Kodu: "[KOMPOZƒ∞SYON_4]",
            
            Puan_Durumu: reportText.split('\n')[3], 
            Rapor: reportText
        };

        fetch("https://formsubmit.co/ajax/" + TEACHER_EMAIL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            showResultScreen(true);
        })
        .catch(error => {
            showResultScreen(false);
        });
    }

    function showResultScreen(isSuccess) {
        document.getElementById('loginScreen').style.display = 'none';
        document.querySelector('.container').style.display = 'none'; 
        document.getElementById('examInterface').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'block';

        const title = document.getElementById('resultTitle');
        const successDiv = document.getElementById('successContent');
        const errorDiv = document.getElementById('backupArea');

        if(isSuccess) {
            title.innerText = "‚úÖ Sƒ±nav Ba≈üarƒ±yla Tamamlandƒ±!";
            title.style.color = "#28a745";
            successDiv.style.display = "block";
            errorDiv.style.display = "none";
        } else {
            title.innerText = "‚ö†Ô∏è G√∂nderim Tamamlanamadƒ±";
            title.style.color = "#dc3545";
            successDiv.style.display = "none"; 
            errorDiv.style.display = "block";  
        }
    }

    function hardReset() {
        let pass = prompt("Sistemi sƒ±fƒ±rlamak i√ßin Y√∂netici ≈ûifresini girin:");
        if(pass === "cavolo") { if(confirm("T√ºm veriler silinecek!")) { localStorage.clear(); location.reload(); } } 
        else { alert("‚õî ≈ûifre yanlƒ±≈ü!"); }
    }

    function addPhrase(t) { document.getElementById('writingAnswer').value += t + " "; }
    function typeChar(char) {
        let el = document.activeElement;
        if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
            let start = el.selectionStart; let end = el.selectionEnd;
            el.value = el.value.slice(0, start) + char + el.value.slice(end);
            el.selectionStart = el.selectionEnd = start + 1; autoSave(); 
        }
    }
    function showDef(t) { 
        let simdi = new Date().toLocaleTimeString(); examLogs.push("[" + simdi + "] S√∂zl√ºk: " + t);
        var x = document.getElementById("vocab-toast"); x.innerText = t; x.className = "show"; setTimeout(()=>{x.className=""},3000); 
    }
    function copyResult() {
        let c = document.getElementById("finalReport"); c.select(); c.setSelectionRange(0,99999);
        navigator.clipboard.writeText(c.value).then(()=>{ alert("Kopyalandƒ±!"); });
    }
    document.addEventListener('contextmenu', event => event.preventDefault());
    function restoreSession() { startExam(true); }
</script>

</body>
</html>
