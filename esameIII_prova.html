<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Esame Livello III - 2025/2026</title>
    <script src="studenti.js"></script>
    
    <style>
        /* GENEL AYARLAR - ≈ûablondan birebir alƒ±ndƒ± */
        body { font-family: 'Segoe UI', Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        
        .container { 
            max-width: 800px; 
            margin: 10px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            padding-bottom: 100px; 
            display: none; 
        }

        #loginScreen { max-width: 90%; margin: 20px auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .honor-code { background: #fff3cd; padding: 15px; border: 1px solid #ffeeba; border-radius: 5px; margin: 20px 0; font-size: 0.85em; text-align: left; line-height: 1.4; }
        
        .password-box {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: left;
        }

        .tech-warning {
            background-color: #e8f4f8;
            color: #0c5460;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.85em;
            text-align: left;
            margin-bottom: 20px;
        }
        .tech-warning ul { margin: 5px 0 0 20px; padding: 0; }
        .tech-warning li { margin-bottom: 5px; }

        .sticky-header { 
            position: sticky; top: 0; background: #2c3e50; color: white; padding: 10px 15px; z-index: 1000; 
            display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        .timer { font-size: 1.3em; font-weight: bold; color: #ffeb3b; font-family: monospace; }
        .save-status { font-size: 0.7em; color: #aaa; margin-left: 10px; }

        h1 { font-size: 1.5em; color: #333; margin-bottom: 10px; }
        h2 { font-size: 1.2em; color: #444; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 25px; }
        
        .question { margin-bottom: 15px; padding: 12px; border-radius: 6px; border: 1px solid #eee; background: #fff; }
        .question label { display: block; padding: 8px 0; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .question input[type="radio"] { transform: scale(1.2); margin-right: 8px; }

        .reading-text { background: #e3f2fd; padding: 15px; border-left: 4px solid #2196f3; font-size: 1.0em; line-height: 1.8; margin-bottom: 10px; border-radius: 4px; }
        
        .vocab { color: #d63384; font-weight: bold; text-decoration: underline dotted; cursor: pointer; position: relative; }
        .vocab:hover { background-color: #fce4ec; }

        #vocab-toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #vocab-toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        
        details.helper-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin-bottom: 15px; font-size: 0.9em; }
        details.helper-box summary { font-weight: bold; color: #007bff; cursor: pointer; outline: none; margin-bottom: 5px; }
        .phrase-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { background: #e9ecef; border: 1px solid #ced4da; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; cursor: pointer; transition: 0.2s; color: #495057; }
        .chip:hover { background: #007bff; color: white; border-color: #007bff; }
        .chip:active { transform: scale(0.95); }

        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; font-family: inherit; }
        
        .inline-input {
            width: 130px !important; display: inline-block !important; margin: 0 5px; padding: 5px !important; height: 30px;
            border-bottom: 2px solid #007bff !important; border-top: none !important; border-left: none !important; border-right: none !important;
            border-radius: 0 !important; background: #f8f9fa; text-align: center; color: #333; font-weight: bold;
        }

        textarea { resize: vertical; min-height: 150px; line-height: 1.5; }

        .btn { display: block; width: 100%; padding: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 25px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-start { background: #28a745; color: white; opacity: 0.5; }
        .btn-submit { background: #007bff; color: white; margin-bottom: 30px; }
        .btn:disabled { background: #bdc3c7; opacity: 0.5; cursor: not-allowed; }
        .btn-restore { background: #ffc107; color: #333; display: none; margin-bottom: 10px; }
        .copy-btn { background: #6f42c1; color: white; margin-top: 10px; }
        .reset-btn { background: #dc3545; color: white; margin-top: 20px; font-size: 14px; padding: 10px; }

        .cheat-alert { display: none; background: #e74c3c; color: white; text-align: center; padding: 12px; font-weight: bold; position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; font-size: 0.9em; }

        audio { width: 100%; margin-top: 10px; height: 40px; }
        
        .result-box { width: 100%; height: 300px; font-family: monospace; font-size: 0.9em; background: #f8f9fa; border: 1px solid #ccc; }
        
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="vocab-toast">Anlamƒ± burada g√∂r√ºnecek</div>

<div id="cheatBanner" class="cheat-alert">
    ‚ö†Ô∏è UYARI: EKRANDAN AYRILDINIZ! <br>
    <span style="font-weight:normal; font-size:0.8em;">Bu durum kayƒ±t altƒ±na alƒ±ndƒ±.</span>
</div>

<div id="loginScreen">
    <h1>üáÆüáπ Esame Livello III</h1>
    <p style="color:#666;">2025/2026 Online Sƒ±nav Giri≈üi</p>
    
    <div class="tech-warning">
        <strong>‚ö†Ô∏è √ñNEMLƒ∞ TEKNƒ∞K KURALLAR:</strong>
        <ul>
            <li>L√ºtfen <strong>"Gizli Sekme" (Incognito)</strong> kullanmayƒ±nƒ±z! (Sistem kayƒ±t yapamaz).</li>
            <li>Elektrik kesilirse veya sayfa kapanƒ±rsa panik yapmayƒ±n. Sƒ±nava <strong>AYNI Cƒ∞HAZ ve AYNI TARAYICI</strong> ile tekrar girerseniz, cevaplarƒ±nƒ±z ve s√ºreniz kaldƒ±ƒüƒ± yerden devam edecektir.</li>
        </ul>
    </div>

    <button id="restoreBtn" class="btn btn-restore" onclick="restoreSession()">
        üîÑ √ñnceki oturumunuz bulundu! <br><span style="font-size:0.8em">Kaldƒ±ƒüƒ±nƒ±z yerden devam etmek i√ßin tƒ±klayƒ±n.</span>
    </button>

    <div id="newSessionForm">
        
        <div class="password-box">
            <label style="color:#0d47a1; font-weight:bold;">üîí Sƒ±nav Giri≈ü Kodu:</label>
            <input type="password" id="examPassword" placeholder="√ñƒüretmeninizden aldƒ±ƒüƒ±nƒ±z ≈üifre..." oninput="checkStartButton()">
        </div>

        <div style="text-align: left; margin-top: 20px;">
            <label><strong>Adƒ±nƒ±z Soyadƒ±nƒ±z:</strong></label>
            <input type="text" id="studentName" list="studentListOptions" placeholder="Listeden se√ßin veya isminizi yazƒ±n..." oninput="checkStartButton()">
            <datalist id="studentListOptions"></datalist>
        </div>

        <div class="honor-code">
            <label style="display: flex; align-items: flex-start; gap: 10px;">
                <input type="checkbox" id="honorCheck" onchange="checkStartButton()">
                <span>
                    <strong>‚ö†Ô∏è SINAV UYARISI:</strong><br>
                    Bilgisayarda <strong>sekme deƒüi≈ütirmek</strong>; <br>
                    Telefon/Tablette ise <strong>bildirim veya arama gelmesi</strong> "Ekran ƒ∞hlali" sayƒ±lƒ±r.<br>
                    L√ºtfen cihazƒ±nƒ±zda gerekli √∂nlemleri alƒ±nƒ±z.<br>
                    Kopya √ßekmeyeceƒüimi taahh√ºt ediyorum.
                </span>
            </label>
        </div>

        <button id="startBtn" class="btn btn-start" onclick="attemptLogin()" disabled>Gƒ∞Rƒ∞≈û YAP VE BA≈ûLAT</button>
    </div>
</div>

<div id="examInterface">
    
    <div class="sticky-header">
        <div style="display:flex; flex-direction:column;">
            <div class="student-name-display" id="displayName">...</div>
            <div id="saveStatus" class="save-status">Kaydedildi</div>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
            <span>‚è±Ô∏è</span>
            <div id="timerDisplay" class="timer">50:00</div>
        </div>
    </div>

    <div class="container">
        
        <div class="section">
            <h2>üéß 1. ASCOLTO (10 Punti)</h2>
            <p>Ascolta il dialogo tra due amici, Ugo e Aldo, e completa le frasi.</p>
            <div style="background: #f1f3f5; padding: 15px; border-radius: 8px; text-align: center;">
                <p style="margin:0 0 5px 0; font-weight:bold;">Ses Dosyasƒ±:</p>
                <audio id="examAudio" controls controlsList="nodownload" onplay="checkAudioLimit()" onended="countAudioPlay()">
                    <source src="esame_livello3.mp3" type="audio/mpeg">
                    Tarayƒ±cƒ±nƒ±z sesi desteklemiyor.
                </audio>
            </div>
            
            <div class="question">
                <p><strong>1. Ugo e Angela per Natale:</strong></p>
                <label><input type="radio" name="q1" value="a" onchange="autoSave()"> a. resteranno a casa</label>
                <label><input type="radio" name="q1" value="b" onchange="autoSave()"> b. hanno prenotato una cena</label>
                <label><input type="radio" name="q1" value="c" onchange="autoSave()"> c. partiranno per un viaggio</label>
            </div>
            <div class="question">
                <p><strong>2. Angela non sa niente perch√®:</strong></p>
                <label><input type="radio" name="q2" value="a" onchange="autoSave()"> a. Ugo vuole fare una sorpresa a Angela</label>
                <label><input type="radio" name="q2" value="b" onchange="autoSave()"> b. Ugo non ha invitato Anna</label>
                <label><input type="radio" name="q2" value="c" onchange="autoSave()"> c. Ugo non ha ancora deciso cosa fare</label>
            </div>
            <div class="question">
                <p><strong>3. Ugo e Angela viaggeranno:</strong></p>
                <label><input type="radio" name="q3" value="a" onchange="autoSave()"> a. in auto e in treno</label>
                <label><input type="radio" name="q3" value="b" onchange="autoSave()"> b. in treno e in autobus</label>
                <label><input type="radio" name="q3" value="c" onchange="autoSave()"> c. in aereo e in treno</label>
            </div>
            <div class="question">
                <p><strong>4. Ugo e Angela a Capodanno saranno:</strong></p>
                <label><input type="radio" name="q4" value="a" onchange="autoSave()"> a. a Madrid</label>
                <label><input type="radio" name="q4" value="b" onchange="autoSave()"> b. a Parigi</label>
                <label><input type="radio" name="q4" value="c" onchange="autoSave()"> c. in Portogallo</label>
            </div>
            <div class="question">
                <p><strong>5. Stefania a Capodanno andr√†:</strong></p>
                <label><input type="radio" name="q5" value="a" onchange="autoSave()"> a. a Venezia</label>
                <label><input type="radio" name="q5" value="b" onchange="autoSave()"> b. a Zurigo</label>
                <label><input type="radio" name="q5" value="c" onchange="autoSave()"> c. al lavoro</label>
            </div>
        </div>

        <div class="section">
            <h2>üìñ 2. LETTURA (10 Punti)</h2>
            <p style="font-size:0.8em; color:gray; text-align:center; margin-bottom:5px;">‚ÑπÔ∏è ƒ∞pucu: Altƒ± √ßizili kelimelerin √ºzerine tƒ±klayarak anlamƒ±nƒ± g√∂rebilirsiniz.</p>
            
            <div class="reading-text">
                <strong>IL SALONE DEL GUSTO: IL FESTIVAL DELLA CUCINA INTERNAZIONALE</strong><br>
                Il movimento <span class="vocab" onclick="showDef('Uluslararasƒ± bir yemek hareketi')">Slow Food</span> organizza il Salone del Gusto, un grande festival internazionale per cuochi, agricoltori, ristoratori e tutte le persone con la passione per il cibo e le bevande.<br><br>
                Il festival √® organizzato ogni anno a Torino ed √® molto particolare perch√© i visitatori possono provare e comprare prodotti da tutti i paesi del mondo: vini, formaggi, dolci, piatti di carne e pesce.<br><br>
                Tutti i prodotti <span class="vocab" onclick="showDef('Esposti = Sergilenen')">esposti</span> sono <span class="vocab" onclick="showDef('Biologici = Organik')">biologici</span> ed <span class="vocab" onclick="showDef('Ecosostenibili = √áevre dostu')">ecosostenibili</span>, rispettando la natura e le comunit√† locali.<br><br>
                Il Salone del Gusto 2024 durer√† dal 20 al 24 Settembre 2024. Pi√π di mille produttori di 130 nazionalit√† diverse presenteranno i loro prodotti.<br><br>
                Ci saranno circa trecentomila visitatori che parteciperanno a pi√π di 500 eventi: conferenze, <span class="vocab" onclick="showDef('Degustazioni = Tadƒ±m etkinlikleri')">degustazioni</span>, laboratori di cucina.<br><br>
                Se il tempo sar√† bello, i visitatori potranno anche fare un pic-nic nella bellissima natura del Parco Dora!<br><br>
                Il festival non sar√† solo un‚Äôoccasione per scoprire cibi buonissimi, ma anche un modo per imparare la cultura di altri paesi.<br><br>
                Se siete interessati, potrete prenotare i biglietti su internet o in <span class="vocab" onclick="showDef('Biglietteria = Bilet gi≈üesi')">biglietteria</span>. I biglietti saranno in vendita sul sito web di Slow Food.
            </div>

            <div class="question">
                <p><strong>1. Il Salone del Gusto:</strong></p>
                <label><input type="radio" name="q6" value="a" onchange="autoSave()"> a. √® il nuovo ristorante di Slow Food a Torino</label>
                <label><input type="radio" name="q6" value="b" onchange="autoSave()"> b. √® un festival solo per chef ed esperti di cucina</label>
                <label><input type="radio" name="q6" value="c" onchange="autoSave()"> c. √® un festival per tutte le persone che amano mangiare e bere</label>
            </div>
            <div class="question">
                <p><strong>2. Il festival √® speciale perch√®:</strong></p>
                <label><input type="radio" name="q7" value="a" onchange="autoSave()"> a. √® organizzato ogni anno in un paese diverso</label>
                <label><input type="radio" name="q7" value="b" onchange="autoSave()"> b. ci sono prodotti tipici italiani</label>
                <label><input type="radio" name="q7" value="c" onchange="autoSave()"> c. ci sono prodotti da diversi paesi del mondo</label>
            </div>
            <div class="question">
                <p><strong>3. Al Salone del Gusto 2024:</strong></p>
                <label><input type="radio" name="q8" value="a" onchange="autoSave()"> a. ci saranno pi√π di 10.000 produttori</label>
                <label><input type="radio" name="q8" value="b" onchange="autoSave()"> b. ci saranno circa 300.000 visitatori</label>
                <label><input type="radio" name="q8" value="c" onchange="autoSave()"> c. ci saranno pi√π di cinquemila eventi</label>
            </div>
            <div class="question">
                <p><strong>4. I visitatori potranno fare un pic-nic al Parco Dora:</strong></p>
                <label><input type="radio" name="q9" value="a" onchange="autoSave()"> a. se il tempo sar√† sereno</label>
                <label><input type="radio" name="q9" value="b" onchange="autoSave()"> b. se piover√†</label>
                <label><input type="radio" name="q9" value="c" onchange="autoSave()"> c. se il tempo sar√† nuvoloso</label>
            </div>
            <div class="question">
                <p><strong>5. Le persone interessate al festival potranno comprare i biglietti:</strong></p>
                <label><input type="radio" name="q10" value="a" onchange="autoSave()"> a. al Parco Doria</label>
                <label><input type="radio" name="q10" value="b" onchange="autoSave()"> b. solo su internet</label>
                <label><input type="radio" name="q10" value="c" onchange="autoSave()"> c. sul sito di Slow Food o in biglietteria</label>
            </div>
        </div>

        <div class="section">
            <h2>‚úçÔ∏è 3. GRAMMATICA (5 Punti)</h2>
            <div style="background:#f1f3f5; padding:5px; margin:10px 0; border-radius:5px; text-align:center;">
                <span style="font-size:0.9em; color:#333; margin-right:10px;">√ñzel Karakter Ekle:</span>
                <button onmousedown="event.preventDefault(); typeChar('√®')" style="font-size:1.2em; padding:5px 15px; cursor:pointer; font-weight:bold; background:white; border:1px solid #ccc; border-radius:4px;">√®</button>
                <button onmousedown="event.preventDefault(); typeChar('√≤')" style="font-size:1.2em; padding:5px 15px; cursor:pointer; font-weight:bold; background:white; border:1px solid #ccc; border-radius:4px;">√≤</button>
            </div>
            
            <p style="font-size:0.9em; color:#666;">Completa con il <strong>futuro semplice</strong> e <strong>anteriore</strong>:</p>
            
            <div class="question" style="line-height: 2.2; font-size: 1.1em;">
                L‚Äôestate prossima io e le mie amiche vogliamo andare in Italia.<br>
                Prima, noi (1) (andare) <input type="text" id="g1" placeholder="..." oninput="autoSave()" class="inline-input"> a Milano. Vogliamo vedere i laghi vicino a Milano.<br>
                Dopo che (2) (noi - visitare) <input type="text" id="g2" placeholder="..." oninput="autoSave()" class="inline-input"> Milano, (3) (fare) <input type="text" id="g3" placeholder="..." oninput="autoSave()" class="inline-input"> una bella gita sul lago di Garda.<br>
                Poi (4) (partire) <input type="text" id="g4" placeholder="..." oninput="autoSave()" class="inline-input"> per il lago Orta.<br>
                Alcuni amici (5) (venire) <input type="text" id="g5" placeholder="..." oninput="autoSave()" class="inline-input"> a trovarci e tutti noi mangeremo in un ristorante locale.
            </div>
        </div>

        <div class="section">
            <h2>üìù 4. PRODUZIONE SCRITTA (5 Punti)</h2>
            <p><strong>Descrivi la tua famiglia. Devi scrivere dalle 40 alle 60 parole.</strong></p>
            
            <div style="background:#eaf6ff; border:1px solid #b6e0fe; padding:10px; border-radius:8px; margin-bottom:10px;">
                <p style="margin:0 0 5px 0; font-weight:bold; font-size:0.9em; color:#0056b3;">üí° Yardƒ±mcƒ± Kalƒ±plar (Tƒ±kla ve Ekle)</p>
                <p style="font-size:0.85em; color:#d63384; font-weight:bold; margin-bottom:10px;">
                    ‚ö†Ô∏è √ñNEMLƒ∞: ≈ûablon ekledikten sonra, noktalƒ± yerleri (...) silip kendi c√ºmlelerinizle tamamlamayƒ± unutmayƒ±n!
                </p>
                
                <details class="helper-box">
                    <summary>1. Giri≈ü (Introduzione)</summary>
                    <div class="phrase-chips">
                        <span class="chip" onclick="addPhrase('La mia famiglia √® composta da...')">La mia famiglia √® composta da...</span>
                        <span class="chip" onclick="addPhrase('Siamo una famiglia numerosa/piccola...')">Siamo una famiglia numerosa/piccola...</span>
                        <span class="chip" onclick="addPhrase('Abitiamo a...')">Abitiamo a...</span>
                    </div>
                </details>

                <details class="helper-box">
                    <summary>2. Aile √úyeleri (Membri)</summary>
                    <div class="phrase-chips">
                        <span class="chip" onclick="addPhrase('Mio padre si chiama... e fa il...')">Mio padre si chiama... e fa il...</span>
                        <span class="chip" onclick="addPhrase('Mia madre √® una...')">Mia madre √® una...</span>
                        <span class="chip" onclick="addPhrase('Ho un fratello/una sorella che...')">Ho un fratello/una sorella che...</span>
                    </div>
                </details>

                <details class="helper-box">
                    <summary>3. Sonu√ß (Conclusione)</summary>
                    <div class="phrase-chips">
                        <span class="chip" onclick="addPhrase('Nel tempo libero noi...')">Nel tempo libero noi...</span>
                        <span class="chip" onclick="addPhrase('Voglio molto bene alla mia famiglia perch√©...')">Voglio molto bene alla mia famiglia perch√©...</span>
                        <span class="chip" onclick="addPhrase('Andiamo sempre d\'accordo.')">Andiamo sempre d'accordo.</span>
                    </div>
                </details>
            </div>

            <div style="margin-bottom:8px; display:flex; gap:5px; flex-wrap:wrap; background:#f1f3f5; padding:8px; border-radius:5px;">
                <span style="font-size:0.9em; width:100%; color:#333; margin-bottom:5px;">√ñzel Karakterler:</span>
                <button onmousedown="event.preventDefault(); typeChar('√†')" style="padding:5px 12px; font-size:1.1em; cursor:pointer; background:white; border:1px solid #ccc; border-radius:4px;">√†</button>
                <button onmousedown="event.preventDefault(); typeChar('√®')" style="padding:5px 12px; font-size:1.1em; cursor:pointer; background:white; border:1px solid #ccc; border-radius:4px;">√®</button>
                <button onmousedown="event.preventDefault(); typeChar('√©')" style="padding:5px 12px; font-size:1.1em; cursor:pointer; background:white; border:1px solid #ccc; border-radius:4px;">√©</button>
                <button onmousedown="event.preventDefault(); typeChar('√¨')" style="padding:5px 12px; font-size:1.1em; cursor:pointer; background:white; border:1px solid #ccc; border-radius:4px;">√¨</button>
                <button onmousedown="event.preventDefault(); typeChar('√≤')" style="padding:5px 12px; font-size:1.1em; cursor:pointer; background:white; border:1px solid #ccc; border-radius:4px;">√≤</button>
                <button onmousedown="event.preventDefault(); typeChar('√π')" style="padding:5px 12px; font-size:1.1em; cursor:pointer; background:white; border:1px solid #ccc; border-radius:4px;">√π</button>
            </div>
            
            <textarea id="writingAnswer" rows="6" placeholder="Buraya yazƒ±n..." oninput="autoSave()"></textarea>
        </div>

        <button class="btn btn-submit" onclick="finishExam(false)">SINAVI Bƒ∞Tƒ∞R VE G√ñNDER</button>
    </div>
</div>

<div id="resultScreen" style="display:none; text-align:center;">
    <h2 id="resultTitle" style="color:#28a745;">‚úÖ Sƒ±nav Ba≈üarƒ±yla Tamamlandƒ±!</h2>
    <div id="successContent">
        <p>Sonu√ßlarƒ±nƒ±z √∂ƒüretmeninize ba≈üarƒ±yla iletildi.</p>
        <div style="font-size:3rem; margin:20px;">üéâ</div>
        <p>Bu pencereyi kapatabilirsiniz.</p>
    </div>
    <div id="backupArea" style="display:none; margin-top:30px; border-top:2px dashed #ccc; padding-top:20px;">
        <p style="color:#dc3545; font-weight:bold; font-size:1.2em;">‚ö†Ô∏è Otomatik g√∂nderim ba≈üarƒ±sƒ±z oldu.</p>
        <p>L√ºtfen a≈üaƒüƒ±daki raporu kopyalayƒ±p WhatsApp'tan √∂ƒüretmeninize g√∂nderin:</p>
        <textarea id="finalReport" class="result-box" readonly></textarea>
        <button class="btn copy-btn" onclick="copyResult()">üìã RAPORU KOPYALA</button>
    </div>
    <button class="btn reset-btn" onclick="hardReset()">‚ö†Ô∏è Sƒ∞STEMƒ∞ SIFIRLA VE √áIKI≈û YAP</button>
</div>

<script>
    // --- MAƒ∞L ADRESƒ∞ ---
    const TEACHER_EMAIL = "corsikumcasaitalia@gmail.com";
    
    // --- √ñƒûRETMEN AYARLARI ---
    const TEACHER_PASSWORD = "START";
    const RESET_PASSWORD = "cavolo";
    const EXAM_DURATION_MINUTES = 50; 
    const SAVE_KEY = "esame_livello3_2025_v1"; 
    
    // --- PUANLAMA AYARLARI ---
    const POINTS_TEST = 2;    
    const POINTS_GRAMMAR = 1; 

    // --- ≈ûƒ∞FRELƒ∞ Gƒ∞ZLƒ∞ ƒ∞Sƒ∞MLER ---
    const SECRET_HASHES = [
        "Um9tYV8xODYx",       
        "RGFudGVfMTI2NQ==",   
        "VmVyZGlfTmFidWNjbw==" 
    ];

    // --- CEVAP ANAHTARI (D√úZENLEME GEREKEBƒ∞Lƒ∞R) ---
    const ANSWER_KEY = {
        // Ascolto (Dinleme): MP3 i√ßeriƒüi bilinmediƒüi i√ßin rastgele 'a' se√ßildi. 
        // L√úTFEN BUNLARI KONTROL EDƒ∞P D√úZELTƒ∞N.
        q1: "a", q2: "a", q3: "a", q4: "a", q5: "a", 
        
        // Lettura (Okuma): Metne g√∂re √ßƒ±karƒ±lmƒ±≈ütƒ±r.
        q6: "c", // sevenler i√ßin
        q7: "c", // farklƒ± √ºlkeler
        q8: "b", // 300.000 ziyaret√ßi
        q9: "a", // hava g√ºzel olursa (sereno)
        q10: "c", // site veya gi≈üe

        // Grammatica: Metne g√∂re doldurulmu≈ütur (Futuro Semplice & Anteriore)
        g1: ["andremo"], 
        g2: ["avremo visitato"], 
        g3: ["faremo"], 
        g4: ["partiremo"], 
        g5: ["verranno"]
    };

    let timerInterval, violationCount = 0, examLogs = [], audioLimit = 2;

    window.onload = function() {
        populateStudentList();
        let savedData = {};
        try { savedData = JSON.parse(localStorage.getItem(SAVE_KEY)) || {}; } catch(e) { savedData = {}; }

        let isMaster = (savedData.name) ? SECRET_HASHES.includes(btoa(savedData.name)) : false;
        if (isMaster) {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('examInterface').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
            return;
        }

        if(localStorage.getItem(SAVE_KEY + "_status") === "completed") { 
            showResultScreen(true);
            return; 
        }

        if(localStorage.getItem(SAVE_KEY + "_startTime")) { 
            document.getElementById('restoreBtn').style.display = 'block'; 
            document.getElementById('newSessionForm').style.display = 'none'; 
        }
    }

    function populateStudentList() {
        const dataList = document.getElementById("studentListOptions");
        if (typeof OGRENCI_LISTESI !== 'undefined') {
            OGRENCI_LISTESI.forEach(name => {
                let opt = document.createElement("option");
                opt.value = name;
                dataList.appendChild(opt);
            });
        }
    }

    function attemptLogin() {
        const inputName = document.getElementById('studentName').value.trim();
        const inputPass = document.getElementById('examPassword').value.trim();
        let isMaster = false;
        try { isMaster = SECRET_HASHES.includes(btoa(inputName)); } catch(e){}

        if (isMaster) {
            localStorage.removeItem(SAVE_KEY + "_status");
            localStorage.removeItem(SAVE_KEY + "_startTime");
            localStorage.removeItem("LOCK_" + inputName);
            startExam(false);
            return;
        }

        if (inputPass !== TEACHER_PASSWORD) { alert("‚ùå HATALI SINAV ≈ûƒ∞FRESƒ∞!"); return; }
        if (localStorage.getItem("LOCK_" + inputName) === "completed") { alert("‚õî BU √ñƒûRENCƒ∞ SINAVI ZATEN TAMAMLADI!"); return; }

        if (typeof OGRENCI_LISTESI !== 'undefined' && OGRENCI_LISTESI.includes(inputName)) { startExam(false); } 
        else { alert("‚õî BU ƒ∞Sƒ∞MLE Gƒ∞Rƒ∞≈û YETKƒ∞Nƒ∞Z YOK!"); }
    }

    function checkStartButton() {
        const name = document.getElementById('studentName').value;
        const pass = document.getElementById('examPassword').value;
        const check = document.getElementById('honorCheck').checked;
        const startBtn = document.getElementById('startBtn');
        if (name.length > 0 && pass.length > 0 && check) {
            startBtn.disabled = false; startBtn.style.opacity = "1"; startBtn.style.backgroundColor = "#28a745";
        } else {
            startBtn.disabled = true; startBtn.style.opacity = "0.5";
        }
    }

    function startExam(isRestored = false) {
        if(!isRestored) examLogs.push("[" + new Date().toLocaleTimeString() + "] Sƒ±nav Ba≈üladƒ±.");
        let sName = document.getElementById('studentName').value;
        if(isRestored) { let d = JSON.parse(localStorage.getItem(SAVE_KEY)); if(d) sName = d.name; }
        if (!localStorage.getItem(SAVE_KEY + "_startTime")) localStorage.setItem(SAVE_KEY + "_startTime", new Date().getTime());

        document.getElementById('displayName').innerText = sName;
        document.getElementById('loginScreen').style.display = 'none';
        document.querySelector('.container').style.display = 'block';
        document.getElementById('examInterface').style.display = 'block'; 
        
        if(isRestored) restoreInputs(); 
        timerInterval = setInterval(updateAbsoluteTimer, 1000);
        updateAbsoluteTimer();
        window.scrollTo(0,0);
        checkAudioLimit();
    }

    function updateAbsoluteTimer() {
        let st = parseInt(localStorage.getItem(SAVE_KEY + "_startTime"));
        if(!st) return;
        let elapsed = Math.floor((new Date().getTime() - st) / 1000);
        let remain = (EXAM_DURATION_MINUTES * 60) - elapsed;
        
        if (remain <= 0) { clearInterval(timerInterval); document.getElementById('timerDisplay').innerText = "00:00"; finishExam(true); return; }
        let m = Math.floor(remain / 60), s = remain % 60;
        document.getElementById('timerDisplay').innerText = (m<10?'0':'')+m + ":" + (s<10?'0':'')+s;
        if (remain <= 300) document.getElementById('timerDisplay').style.color = "red";
        if(remain % 10 === 0) autoSave();
    }

    function autoSave() {
        let answers = {}, grammar = {};
        for(let i=1; i<=10; i++) { let r = document.querySelector(`input[name="q${i}"]:checked`); if(r) answers["q"+i] = r.value; }
        for(let i=1; i<=5; i++) { grammar["g"+i] = document.getElementById('g'+i).value; }
        let data = { name: document.getElementById('displayName').innerText, writing: document.getElementById('writingAnswer').value, answers: answers, grammar: grammar, logs: examLogs, violations: violationCount };
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        let st = document.getElementById('saveStatus'); if(st) { st.innerText = "Kaydedildi"; setTimeout(() => { st.innerText = ""; }, 1000); }
    }

    function restoreInputs() {
        let data = JSON.parse(localStorage.getItem(SAVE_KEY));
        if(!data) return;
        violationCount = data.violations || 0; examLogs = data.logs || [];
        if(data.answers) for(let i=1; i<=10; i++) { if(data.answers["q"+i]) { let el = document.querySelector(`input[name="q${i}"][value="${data.answers["q"+i]}"]`); if(el) el.checked = true; } }
        if(data.grammar) for(let i=1; i<=5; i++) { if(data.grammar["g"+i]) document.getElementById('g'+i).value = data.grammar["g"+i]; }
        if(data.writing) document.getElementById('writingAnswer').value = data.writing;
    }

    function checkAudioLimit() {
        let played = parseInt(localStorage.getItem(SAVE_KEY + "_audioPlay")) || 0;
        let p = document.getElementById("examAudio");
        if (played >= audioLimit) { if(!p.paused) { p.pause(); p.currentTime = 0; alert("‚ö†Ô∏è Dinleme hakkƒ± doldu!"); } p.style.opacity = "0.5"; p.style.pointerEvents = "none"; }
    }
    function countAudioPlay() {
        let played = parseInt(localStorage.getItem(SAVE_KEY + "_audioPlay")) || 0;
        played++; localStorage.setItem(SAVE_KEY + "_audioPlay", played);
        if(played >= audioLimit) { alert("Dinleme hakkƒ± bitti."); document.getElementById("examAudio").style.opacity = "0.5"; document.getElementById("examAudio").style.pointerEvents = "none"; }
    }

    let ayrilmaZamani;
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) { ayrilmaZamani = new Date().getTime(); } else {
            if (ayrilmaZamani && document.getElementById('examInterface').style.display !== 'none') {
                let farkSaniye = Math.floor((new Date().getTime() - ayrilmaZamani) / 1000);
                violationCount++;
                examLogs.push("[" + new Date().toLocaleTimeString() + "] ‚ö†Ô∏è ƒ∞HLAL: Ekran Terk Edildi. " + farkSaniye + "sn.");
                document.getElementById('cheatBanner').style.display = 'block';
                setTimeout(() => { document.getElementById('cheatBanner').style.display = 'none'; }, 4000);
                ayrilmaZamani = null;
            }
        }
    });

    function generateReport() {
        let data = JSON.parse(localStorage.getItem(SAVE_KEY)) || {};
        let totalScore = 0;
        
        let report = "--- ƒ∞TALYANCA SINAV SONUCU (LEVEL 3) ---\n";
        report += "√ñƒürenci: " + (data.name || "-") + "\n";
        report += "Tarih: " + new Date().toLocaleString() + "\n";
        
        let details = "\n[TEST B√ñL√úM√ú (Ascolto + Lettura) (20 Puan)]\n";
        if(data.answers) {
            for(let i=1; i<=10; i++) {
                let ans = data.answers["q"+i];
                let correct = ANSWER_KEY["q"+i];
                let isCorrect = (ans === correct);
                if(isCorrect) totalScore += POINTS_TEST;
                details += i + ". " + (ans ? ans.toUpperCase() : "-") + " " + (isCorrect ? "‚úÖ" : "‚ùå") + "\n";
            }
        }

        details += "\n[GRAMER B√ñL√úM√ú (5 Puan)]\n";
        if(data.grammar) {
            for(let i=1; i<=5; i++) {
                let ans = (data.grammar["g"+i] || "").trim();
                let correctOptions = ANSWER_KEY["g"+i]; 
                let isCorrect = correctOptions.some(opt => opt.toLowerCase() === ans.toLowerCase());
                if(isCorrect) totalScore += POINTS_GRAMMAR;
                details += "G" + i + ": " + ans + " " + (isCorrect ? "‚úÖ" : "‚ùå") + "\n";
            }
        }

        report += "OTOMATƒ∞K PUAN: " + totalScore + " / 25\n";
        report += "ƒ∞HLAL SAYISI: " + (data.violations || 0) + "\n";
        report += "\n[DETAYLAR]\n" + details; 
        report += "\n[KOMPOZƒ∞SYON_3]\n" + (data.writing || "-") + "\n";
        
        report += "\n[LOGLAR]\n";
        if(data.logs) data.logs.forEach(log => { report += log + "\n"; });
        
        return report;
    }

    function finishExam(forced) {
        if(!forced && !confirm("Sƒ±navƒ± bitirmek ve hocaya g√∂ndermek istediƒüinize emin misiniz?")) return;
        
        clearInterval(timerInterval); 
        autoSave();
        
        const submitBtn = document.querySelector('.btn-submit');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner"></div> L√ºtfen Bekleyin...';

        let sName = document.getElementById('displayName').innerText;
        localStorage.setItem("LOCK_" + sName, "completed");
        localStorage.setItem(SAVE_KEY + "_status", "completed");
        
        let reportText = generateReport();
        document.getElementById('finalReport').value = reportText;
        
        const formData = {
            _subject: "üáÆüáπ Sƒ±nav (L3): " + sName,
            Ogrenci: sName,
            Puan_Durumu: reportText.split('\n')[3], 
            Rapor: reportText
        };

        fetch("https://formsubmit.co/ajax/" + TEACHER_EMAIL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            showResultScreen(true);
        })
        .catch(error => {
            showResultScreen(false);
        });
    }

    function showResultScreen(isSuccess) {
        document.getElementById('loginScreen').style.display = 'none';
        document.querySelector('.container').style.display = 'none'; 
        document.getElementById('examInterface').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'block';

        const title = document.getElementById('resultTitle');
        const successDiv = document.getElementById('successContent');
        const errorDiv = document.getElementById('backupArea');

        if(isSuccess) {
            title.innerText = "‚úÖ Sƒ±nav Ba≈üarƒ±yla Tamamlandƒ±!";
            title.style.color = "#28a745";
            successDiv.style.display = "block";
            errorDiv.style.display = "none";
        } else {
            title.innerText = "‚ö†Ô∏è G√∂nderim Tamamlanamadƒ±";
            title.style.color = "#dc3545";
            successDiv.style.display = "none"; 
            errorDiv.style.display = "block";  
        }
    }

    function hardReset() {
        let pass = prompt("Sistemi sƒ±fƒ±rlamak i√ßin Y√∂netici ≈ûifresini girin:");
        if(pass === "cavolo") { if(confirm("T√ºm veriler silinecek!")) { localStorage.clear(); location.reload(); } } 
        else { alert("‚õî ≈ûifre yanlƒ±≈ü!"); }
    }

    function addPhrase(t) { document.getElementById('writingAnswer').value += t + " "; }
    function typeChar(char) {
        let el = document.activeElement;
        if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
            let start = el.selectionStart; let end = el.selectionEnd;
            el.value = el.value.slice(0, start) + char + el.value.slice(end);
            el.selectionStart = el.selectionEnd = start + 1; autoSave(); 
        }
    }
    function showDef(t) { 
        let simdi = new Date().toLocaleTimeString(); examLogs.push("[" + simdi + "] S√∂zl√ºk: " + t);
        var x = document.getElementById("vocab-toast"); x.innerText = t; x.className = "show"; setTimeout(()=>{x.className=""},3000); 
    }
    function copyResult() {
        let c = document.getElementById("finalReport"); c.select(); c.setSelectionRange(0,99999);
        navigator.clipboard.writeText(c.value).then(()=>{ alert("Kopyalandƒ±!"); });
    }
    document.addEventListener('contextmenu', event => event.preventDefault());
    function restoreSession() { startExam(true); }
</script>

</body>
</html>
